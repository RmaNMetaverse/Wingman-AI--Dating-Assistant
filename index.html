<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wingman AI</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wingman AI">
    
    <!-- Theme Color for Mobile Browsers -->
    <meta name="theme-color" content="#0f0c29">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts: Using System Fonts for iOS Feel -->
    <style>
        body {
            /* iOS System Font Stack */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #e0e0e0;
            overscroll-behavior-y: none;
            
            /* Liquid Background Animation */
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #141e30);
            background-size: 400% 400%;
            animation: liquidGradient 15s ease infinite;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle inside app */
        }

        @keyframes liquidGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* iOS 26 Liquid Glass Style */
        .liquid-glass {
            background: rgba( 255, 255, 255, 0.03 );
            box-shadow: 0 8px 32px 0 rgba( 0, 0, 0, 0.5 );
            backdrop-filter: blur( 24px );
            -webkit-backdrop-filter: blur( 24px );
            border: 1px solid rgba( 255, 255, 255, 0.15 );
            border-top: 1px solid rgba( 255, 255, 255, 0.25 ); /* Highlight top edge */
        }

        /* Etched Glass Inputs */
        .glass-input {
            background: rgba( 0, 0, 0, 0.2 );
            border: 1px solid rgba( 255, 255, 255, 0.1 );
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
            color: white;
        }
        .glass-input:focus {
            background: rgba( 0, 0, 0, 0.4 );
            border-color: rgba( 129, 140, 248, 0.5 ); /* Indigo glow */
            box-shadow: 0 0 15px rgba( 129, 140, 248, 0.2 );
            outline: none;
        }

        /* Glass Buttons */
        .glass-btn-active {
            background: rgba( 255, 255, 255, 0.1 );
            border-bottom: 2px solid #818cf8;
            text-shadow: 0 0 8px rgba(129, 140, 248, 0.6);
            color: white;
        }
        .glass-btn-inactive {
            color: rgba(255, 255, 255, 0.4);
        }
        .glass-btn-inactive:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba( 255, 255, 255, 0.05 );
        }

        /* Main Action Button Gradient */
        .liquid-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .liquid-action-btn:active {
            transform: scale(0.98);
        }

        /* Custom Scrollbar specifically for the glass feel */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2); 
            border-radius: 10px;
        }
        
        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Select Styling */
        select.vibe-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a5b4fc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        select.vibe-select option {
            background-color: #1e1b4b;
            color: #e0e7ff;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useRef } = React;

    // --- Components ---

    const TabButton = ({ active, onClick, icon, label }) => (
        <button 
            onClick={onClick}
            className={`flex-1 py-4 text-center transition-all duration-300 ${
                active ? 'glass-btn-active bg-white/10' : 'text-gray-400 hover:text-white hover:bg-white/5'
            }`}
        >
            <i className={`fa-solid ${icon} mb-1 block text-lg ${active ? 'text-indigo-300' : ''}`}></i>
            <span className="text-[10px] uppercase tracking-widest font-bold">{label}</span>
        </button>
    );

    const SuggestionCard = ({ title, text, onCopy }) => {
        // Each SuggestionCard represents a single message option.
        // Render the whole text in one card and provide one copy button for the full message.
        return (
            <div className="bg-white/5 border border-white/10 rounded-2xl p-5 mb-4 backdrop-blur-md shadow-lg transition-transform hover:scale-[1.01]">
                <div className="flex justify-between items-start mb-3">
                    <span className="text-[10px] font-bold text-indigo-300 uppercase tracking-widest px-2 py-1 bg-indigo-500/20 rounded-full border border-indigo-500/20">{title}</span>
                    <button
                        onClick={() => onCopy(text)}
                        className="text-white/40 hover:text-white transition-colors p-1"
                        title="Copy to clipboard"
                    >
                        <i className="fa-regular fa-copy"></i>
                    </button>
                </div>

                <p className="text-gray-100 text-sm leading-relaxed whitespace-pre-wrap font-medium">{text}</p>
            </div>
        );
    };

    const LanguageCheckbox = ({ lang, selected, toggle }) => (
        <div 
            onClick={() => toggle(lang)}
            className={`cursor-pointer px-3 py-1.5 rounded-full border text-[11px] font-semibold transition-all backdrop-blur-sm ${
                selected 
                ? 'bg-indigo-500/80 border-indigo-400 text-white shadow-[0_0_10px_rgba(99,102,241,0.4)]' 
                : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10'
            }`}
        >
            {lang} {selected && <i className="fa-solid fa-check ml-1 text-[10px]"></i>}
        </div>
    );

    const SetupBanner = ({ onGoToSettings }) => (
        <div className="bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-white/10 rounded-2xl p-4 mb-6 flex items-start gap-4 backdrop-blur-sm">
            <div className="bg-indigo-500/20 p-2.5 rounded-full shrink-0 border border-indigo-500/30">
                 <i className="fa-solid fa-key text-indigo-300"></i>
            </div>
            <div>
                <h4 className="text-indigo-200 text-sm font-bold mb-1">Setup Required</h4>
                <p className="text-gray-400 text-xs mb-3 leading-relaxed">Connect your free Google Gemini API key to activate the AI.</p>
                <button 
                    onClick={onGoToSettings}
                    className="text-xs bg-white/10 hover:bg-white/20 border border-white/20 text-white px-4 py-2 rounded-full transition-all font-semibold"
                >
                    Open Settings
                </button>
            </div>
        </div>
    );

    const LanguageShortcut = ({ langs, onGoToSettings }) => (
        <div className="flex justify-between items-center px-1 mb-2 mt-1">
             <div className="text-[10px] text-gray-500 uppercase font-bold tracking-widest pl-1">
                Language
             </div>
             <button 
                onClick={onGoToSettings} 
                className="text-[10px] text-indigo-300 hover:text-white flex items-center gap-1.5 transition-colors bg-white/5 px-3 py-1.5 rounded-full border border-white/10 hover:border-white/20 hover:bg-white/10"
            >
                <i className="fa-solid fa-globe"></i>
                {langs.join(', ')}
                <i className="fa-solid fa-chevron-right text-[8px] ml-1 opacity-50"></i>
             </button>
        </div>
    );

    // Image Upload Component
    const ImageUploader = ({ images, onUpload, onRemove, label }) => {
        const fileInputRef = useRef(null);

        return (
            <div className="mb-5">
                <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">{label}</label>
                
                {/* Image Grid */}
                {images.length > 0 && (
                    <div className="flex gap-3 mb-3 overflow-x-auto pb-2 scrollbar-hide">
                        {images.map((img, idx) => (
                            <div key={idx} className="relative w-20 h-24 shrink-0 rounded-2xl overflow-hidden border border-white/20 group shadow-lg">
                                <img src={img.data} className="w-full h-full object-cover" />
                                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors"></div>
                                <button 
                                    onClick={() => onRemove(idx)}
                                    className="absolute top-1 right-1 bg-black/60 text-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] backdrop-blur opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100"
                                >
                                    <i className="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        ))}
                    </div>
                )}

                {/* Upload Button */}
                {images.length < 5 && (
                    <div 
                        onClick={() => fileInputRef.current.click()}
                        className="border-2 border-dashed border-white/10 hover:border-indigo-400/50 bg-white/5 hover:bg-white/10 rounded-2xl p-5 text-center cursor-pointer transition-all group"
                    >
                        <i className="fa-solid fa-cloud-arrow-up text-gray-500 group-hover:text-indigo-400 text-2xl mb-2 transition-colors"></i>
                        <p className="text-xs text-gray-400 group-hover:text-gray-300 font-medium">
                            Upload Screenshots <br/> 
                            <span className="text-[10px] text-gray-600 font-normal mt-1 block opacity-70">Tap or <span className="text-indigo-300 font-bold">Ctrl+V</span> to paste</span>
                        </p>
                        <input 
                            type="file" 
                            ref={fileInputRef} 
                            onChange={onUpload} 
                            className="hidden" 
                            accept="image/*" 
                            multiple
                        />
                    </div>
                )}
            </div>
        );
    };

    function App() {
        const [activeTab, setActiveTab] = useState('opener'); 
        const [apiKey, setApiKey] = useState('');
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [suggestions, setSuggestions] = useState([]);
    const [vibeAnalysis, setVibeAnalysis] = useState('');
    // Intro texts (planning/analysis) extracted from model output; shown as plain text (no copy)
    const [introTexts, setIntroTexts] = useState([]);
    const [selectedLangs, setSelectedLangs] = useState(['English']);
        const AVAILABLE_LANGS = ['English', 'Spanish', 'Farsi', 'French', 'German', 'Portuguese', 'Italian', 'Russian', 'Japanese', 'Chinese'];
        const [herBio, setHerBio] = useState('');
        const [herInterests, setHerInterests] = useState('');
        const [openerImages, setOpenerImages] = useState([]);
        const [chatHistory, setChatHistory] = useState('');
        const [replyImages, setReplyImages] = useState([]);
    const [myVibe, setMyVibe] = useState('Funny & Witty');
    const [showKeyHint, setShowKeyHint] = useState(false);
    // Ref to the results area so we can scroll to it after results arrive
    const resultsRef = useRef(null);

        useEffect(() => {
            const storedKey = localStorage.getItem('gemini_api_key');
            if (storedKey) setApiKey(storedKey);
            const storedLangs = localStorage.getItem('wingman_langs');
            if (storedLangs) setSelectedLangs(JSON.parse(storedLangs));
        }, []);

        const handleSaveKey = (key) => {
            setApiKey(key);
            localStorage.setItem('gemini_api_key', key);
        };

        // Only allow selecting a single language. Clicking any language will select it exclusively.
        const toggleLanguage = (lang) => {
            if (selectedLangs[0] === lang) {
                // already selected — keep it (do not allow deselecting to empty)
                return;
            }
            const newLangs = [lang];
            setSelectedLangs(newLangs);
            localStorage.setItem('wingman_langs', JSON.stringify(newLangs));
        };

        // Handle Paste Events
        useEffect(() => {
            const handlePaste = (e) => {
                if (activeTab !== 'opener' && activeTab !== 'reply') return;
                const items = e.clipboardData.items;
                let foundImage = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        foundImage = true;
                        const file = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const setter = activeTab === 'opener' ? setOpenerImages : setReplyImages;
                            setter(prev => {
                                if (prev.length >= 5) return prev; 
                                return [...prev, { data: reader.result, mime: file.type }];
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                }
                if (foundImage) e.preventDefault();
            };
            window.addEventListener('paste', handlePaste);
            return () => window.removeEventListener('paste', handlePaste);
        }, [activeTab]);

        const handleImageUpload = (e, setImages, currentImages) => {
            const files = Array.from(e.target.files);
            const remainingSlots = 5 - currentImages.length;
            const filesToProcess = files.slice(0, remainingSlots);
            filesToProcess.forEach(file => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setImages(prev => [...prev, { data: reader.result, mime: file.type }]);
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        };

        const removeImage = (index, setImages) => {
            setImages(prev => prev.filter((_, i) => i !== index));
        };

        const copyToClipboard = (text) => {
            if (!text) return;

            // Helper to clean a single line by removing:
            // - Leading bullets or markers (*, -, •)
            // - Leading numbering (e.g. "3.", "2)")
            // - Leading labeled prefixes (option titles) possibly wrapped in markdown bold, e.g. "**Playful**:", "**جسور:**"
            const cleanLine = (line) => {
                if (!line) return line;
                // Remove common bullet markers
                line = line.replace(/^\s*[\*\-\u2022]\s*/, '');
                // Remove leading numbering like "3.", "1)", "2 -"
                line = line.replace(/^\s*\d+\s*[\.\)\-–—]*\s*/, '');
                // Remove leading markdown bold/underline markers like '**', '__', '*' or '_' if left alone
                line = line.replace(/^\s*(?:\*{1,2}|_{1,2})\s*/, '');
                // Remove leading labeled prefixes (with optional bold markup) followed by colon/dash/parenthesis
                // Examples matched: "**Playful**:", "Playful:", "3. **جسور:**"
                line = line.replace(/^(?:\*{1,2}\s*)?[^:\n]{1,60}?(?:\s*\*{1,2})?\s*[:\-–—)\]]\s*/u, '');
                // If there are still leftover leading markdown markers like '** ' remove them
                line = line.replace(/^\s*(?:\*{1,2}|_{1,2})\s*/, '');
                // Remove any leftover leading punctuation sequences often left by formatting/labels (e.g. ":**", ":-", "**:")
                line = line.replace(/^[\s\:\*\_\-»«\u200F\u200E]+/, '');
                return line;
            };

            const cleaned = text.split(/\r?\n/).map(cleanLine).join('\n').trim();

            try {
                navigator.clipboard.writeText(cleaned);
            } catch (e) {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = cleaned;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }
        };

        // Auto-scroll to results when they appear (suggestions, vibeAnalysis, or introTexts)
        useEffect(() => {
            if ((suggestions && suggestions.length) || vibeAnalysis || (introTexts && introTexts.length)) {
                if (resultsRef && resultsRef.current) {
                    // small timeout to allow rendering/layout
                    setTimeout(() => {
                        try {
                            resultsRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } catch (e) {
                            resultsRef.current.scrollIntoView();
                        }
                    }, 80);
                }
            }
        }, [suggestions, vibeAnalysis, introTexts]);

        const generateContent = async () => {
            if (!apiKey) {
                setError("Please enter your Gemini API Key in Settings.");
                setActiveTab('settings');
                return;
            }
            setLoading(true);
            setError('');
            setSuggestions([]);
            setVibeAnalysis('');
            setIntroTexts([]);

            // Build a clear language instruction for the model.
            // If only one language is selected, ask the model to ONLY output that language.
            // If multiple languages are selected, ask for clearly labeled sections (e.g. "Farsi:")
            // and only include languages from the selected list. Put English first only when included.
            let langInstruction = '';
            if (selectedLangs.length === 1) {
                langInstruction = `Output language: ${selectedLangs[0]}. ONLY output this language and do NOT include English unless it is the selected language.`;
            } else {
                langInstruction = `Output languages: ${selectedLangs.join(', ')}. For each language, clearly label the section with the language name on its own line (for example: "Farsi:") followed by the messages. Do NOT include any languages outside this list. If English is included, put English first.`;
            }
            let systemInstruction = "";
            let userPromptText = "";
            let imagesToSend = [];

            if (activeTab === 'opener') {
                systemInstruction = `Role: Expert dating coach. Task: Write openers.
                Guidelines:
                1. ANALYZE VISUALS if images present (hobbies, travel, pets).
                2. 3 DISTINCT options: Playful, Observational, Bold.
                3. Short & engaging.
                4. Vibe: ${myVibe}
                5. ${langInstruction}`;

                userPromptText = `Bio: "${herBio}" Context: "${herInterests}" (Prioritize screenshots if attached)`;
                imagesToSend = openerImages;
            } else {
                systemInstruction = `Role: Expert dating coach. Task: Write replies.
                Guidelines:
                1. READ CHAT LOGS in screenshots.
                2. "VIBE CHECK": Briefly analyze tone/intent.
                3. 3 DISTINCT replies: Flowing, Escalate/Flirt, The Close.
                4. Vibe: ${myVibe}
                5. ${langInstruction}`;

                userPromptText = `History: ${chatHistory} (Prioritize screenshots if attached)`;
                imagesToSend = replyImages;
            }

            const contentParts = [{ text: userPromptText }];
            imagesToSend.forEach(img => {
                const base64Data = img.data.split(',')[1];
                contentParts.push({ inline_data: { mime_type: img.mime, data: base64Data } });
            });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: contentParts }],
                        system_instruction: { parts: [{ text: systemInstruction }] },
                        generationConfig: { temperature: 0.8, maxOutputTokens: 8192 },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                        ]
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || 'API Request Failed');
                }
                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0) throw new Error("No response (Safety Filter?).");
                
                const candidate = data.candidates[0];
                if (!candidate.content) {
                     if (candidate.finishReason === 'SAFETY') throw new Error("Blocked by Safety Filters.");
                     throw new Error(`Empty response. Reason: ${candidate.finishReason}`);
                }

                let rawText = candidate.content.parts[0].text;
                if (rawText && rawText.includes("VIBE CHECK")) {
                    const parts = rawText.split(/VIBE CHECK:?/i);
                    if (parts.length > 1) {
                         const analysisEnd = parts[1].search(/(Option 1|1\.|Here are)/i);
                         if (analysisEnd !== -1) {
                             setVibeAnalysis(parts[1].substring(0, analysisEnd).trim());
                             rawText = parts[1].substring(analysisEnd).trim();
                         } else {
                             rawText = parts[1]; 
                         }
                    }
                }
                // Parse the rawText into language-specific messages and produce a flat list
                // of suggestion entries so each language/message has its own copy button.
                const escapeRegex = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

                const parseSections = (text, langs) => {
                    if (!text) return [];
                    const sections = [];
                    const splitNumberedList = (t) => {
                        // Match numbered items like "1. text" or "1) text" across the text and return array of texts
                        const itemRegex = /(^|\n)\s*(?:\d+|(?:Option\s*\d+))\s*[\.)\-:]\s*/gim;
                        // If there is no numbered pattern, return null
                        if (!itemRegex.test(t)) return null;
                        // Reconstruct by scanning lines for markers instead
                        const results = [];
                        let current = null;
                        const lines = t.split(/\r?\n/);
                        for (let line of lines) {
                            if (/^\s*(?:\d+|Option\s*\d+)\s*[\.)\-:]\s*/i.test(line)) {
                                if (current) results.push(current.trim());
                                current = line.replace(/^\s*(?:\d+|Option\s*\d+)\s*[\.)\-:]\s*/i, '');
                            } else {
                                if (current === null) current = line; else current += ' ' + line;
                            }
                        }
                        if (current) results.push(current.trim());
                        return results.filter(Boolean);
                    };

                    // Attempt to find explicit language headings (one-per-line) like "Farsi:" or "Farsi".
                    const headingRegex = new RegExp(`^\\s*(?:${langs.map(l => escapeRegex(l)).join('|')})\\s*[:\-–—]*\\s*$`, 'gim');
                    const matches = [];
                    let m;
                    while ((m = headingRegex.exec(text)) !== null) {
                        matches.push({ index: m.index, match: m[0].trim(), lang: m[0].trim().replace(/[:\-–—]+$/, '').trim() });
                    }

                    if (matches.length > 0) {
                        // Build sections between headings
                        for (let i = 0; i < matches.length; i++) {
                            const start = matches[i].index + matches[i].match.length;
                            const end = i + 1 < matches.length ? matches[i+1].index : text.length;
                            const body = text.substring(start, end).trim();
                            // Prefer numbered list splitting when present
                            const numbered = splitNumberedList(body);
                            const msgs = (numbered && numbered.length) ? numbered : body.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
                            sections.push({ lang: matches[i].lang.replace(/[:\-–—]+$/, '').trim(), messages: msgs });
                        }
                        return sections;
                    }

                    // If no clear headings, try to find inline labels like "Farsi:" anywhere
                    const inlineSections = [];
                    for (const lang of langs) {
                        const re = new RegExp(`${escapeRegex(lang)}\\s*[:\-–—]+\\s*`, 'i');
                        const res = text.split(re);
                        if (res.length > 1) {
                            // res[0] is before first label; the subsequent parts are candidates
                            // We'll join everything after the first label and split by double-newline
                            const after = res.slice(1).join('');
                            const numbered = splitNumberedList(after);
                            const msgs = (numbered && numbered.length) ? numbered : after.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
                            inlineSections.push({ lang, messages: msgs });
                        }
                    }
                    if (inlineSections.length > 0) return inlineSections;

                    // Fallbacks:
                    // - If only one language selected, assign whole text to that language split by blank lines.
                    if (langs.length === 1) {
                        const numbered = splitNumberedList(text);
                        const msgs = (numbered && numbered.length) ? numbered : text.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
                        return [{ lang: langs[0], messages: msgs }];
                    }

                    // - If multiple languages but no labels found, split text into chunks by blank lines
                    //   and distribute them round-robin across the selected languages.
                    const numbered = splitNumberedList(text);
                    const chunks = (numbered && numbered.length) ? numbered : text.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
                    const distributed = langs.map(l => ({ lang: l, messages: [] }));
                    for (let i = 0; i < chunks.length; i++) {
                        distributed[i % distributed.length].messages.push(chunks[i]);
                    }
                    return distributed;
                };

                const parsed = parseSections(rawText, selectedLangs);
                const suggestionsList = [];
                const intros = [];

                const isLikelyIntro = (text) => {
                    if (!text) return false;
                    const t = text.trim();
                    const lower = t.toLowerCase();
                    // Require both a planning keyword and a moderate length to be considered intro
                    const introKeywords = ['plan', 'analysis', 'vibe check', 'vibe', 'approach', 'steps', 'summary', 'background', 'context', 'strategy', 'here are', "here's", 'analysis:'];
                    const hasKeyword = introKeywords.some(k => lower.includes(k));
                    if (hasKeyword && lower.length > 60) return true;
                    // Very long blocks are probably intro
                    if (lower.length > 400) return true;
                    return false;
                };

                if (parsed.length === 0) {
                    // final fallback: show rawText as one response with a generic title
                    if (isLikelyIntro(rawText)) {
                        intros.push({ lang: selectedLangs[0] || 'Text', text: rawText });
                    } else {
                        suggestionsList.push({ title: 'Response', text: rawText });
                    }
                } else {
                    parsed.forEach(section => {
                        const msgs = section.messages && section.messages.length ? [...section.messages] : [rawText];
                        // If the first message looks like planning/analysis, treat as intro (no copy)
                        if (msgs.length > 0 && isLikelyIntro(msgs[0])) {
                            intros.push({ lang: section.lang, text: msgs.shift() });
                        }
                        msgs.forEach((m, i) => {
                            suggestionsList.push({ title: `${section.lang} • Option ${i+1}`, text: m });
                        });
                    });
                }

                setIntroTexts(intros);
                setSuggestions(suggestionsList);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="flex items-center justify-center min-h-screen p-4 sm:p-6">
                <div className="w-full max-w-md liquid-glass rounded-3xl overflow-hidden flex flex-col h-[85vh] shadow-2xl relative">
                    
                    {/* Header */}
                    <header className="p-5 border-b border-white/10 flex justify-between items-center bg-white/5 backdrop-blur-sm">
                        <div className="flex items-center gap-3">
                            <img 
                                src="icon-192.png" 
                                alt="Logo" 
                                className="w-9 h-9 rounded-xl shadow-lg shadow-black/20 object-cover" 
                                onError={(e) => {
                                    e.target.onerror = null; 
                                    e.target.style.display = 'none'; 
                                    e.target.nextSibling.style.display = 'flex';
                                }}
                            />
                            <div className="hidden w-9 h-9 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-500 items-center justify-center shadow-lg">
                                <i className="fa-solid fa-wind text-white text-sm"></i>
                            </div>
                            <div>
                                <h1 className="text-lg font-bold tracking-tight text-white leading-none">Wingman</h1>
                                <span className="text-[10px] text-indigo-300 font-medium tracking-wide">AI ASSISTANT</span>
                            </div>
                        </div>
                        <div className={`w-2.5 h-2.5 rounded-full ${apiKey ? 'bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.6)]' : 'bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.6)]'}`}></div>
                    </header>

                    {/* Content Area */}
                    <div className="flex-1 overflow-y-auto p-6 pb-28 relative">
                        
                        {error && (
                            <div className="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-200 text-xs font-medium flex items-start gap-3 backdrop-blur-md">
                                <i className="fa-solid fa-circle-exclamation mt-0.5"></i>
                                {error}
                            </div>
                        )}

                        {activeTab === 'opener' && (
                            <div className="space-y-5 animate-fade-in">
                                {!apiKey && <SetupBanner onGoToSettings={() => setActiveTab('settings')} />}
                                {apiKey && <LanguageShortcut langs={selectedLangs} onGoToSettings={() => setActiveTab('settings')} />}

                                <ImageUploader label="Analyze Profile" images={openerImages} onUpload={(e) => handleImageUpload(e, setOpenerImages, openerImages)} onRemove={(idx) => removeImage(idx, setOpenerImages)} />

                                <div className="relative border-t border-white/10 pt-4 mt-2">
                                    <span className="absolute -top-2.5 left-1/2 -translate-x-1/2 px-2 text-[9px] text-gray-500 font-bold uppercase tracking-widest bg-transparent backdrop-blur-md rounded-full">Or Type Details</span>
                                </div>

                                <div>
                                    <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Her Bio</label>
                                    <textarea 
                                        className="w-full glass-input rounded-2xl p-4 text-sm resize-none h-20 placeholder-gray-500"
                                        placeholder="Paste bio text..."
                                        value={herBio}
                                        onChange={(e) => setHerBio(e.target.value)}
                                    ></textarea>
                                </div>
                                <div>
                                    <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Context</label>
                                    <input 
                                        type="text" 
                                        className="w-full glass-input rounded-xl p-4 text-sm placeholder-gray-500"
                                        placeholder="Keywords (e.g. Hiking, Dogs)"
                                        value={herInterests}
                                        onChange={(e) => setHerInterests(e.target.value)}
                                    />
                                </div>
                                <div>
                                    <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Vibe</label>
                                    <select 
                                        value={myVibe}
                                        onChange={(e) => setMyVibe(e.target.value)}
                                        className="w-full vibe-select glass-input rounded-xl p-4 text-sm cursor-pointer"
                                    >
                                        <option>Funny & Witty</option>
                                        <option>Direct & Confident</option>
                                        <option>Casual & Low-key</option>
                                        <option>Intellectual & Deep</option>
                                        <option>Flirty & Playful</option>
                                        <option>Sexting (Spicy)</option>
                                    </select>
                                </div>
                            </div>
                        )}

                        {activeTab === 'reply' && (
                            <div className="space-y-5 animate-fade-in">
                                {!apiKey && <SetupBanner onGoToSettings={() => setActiveTab('settings')} />}
                                {apiKey && <LanguageShortcut langs={selectedLangs} onGoToSettings={() => setActiveTab('settings')} />}
                                
                                <ImageUploader label="Analyze Chat" images={replyImages} onUpload={(e) => handleImageUpload(e, setReplyImages, replyImages)} onRemove={(idx) => removeImage(idx, setReplyImages)} />

                                <div className="relative border-t border-white/10 pt-4 mt-2">
                                    <span className="absolute -top-2.5 left-1/2 -translate-x-1/2 px-2 text-[9px] text-gray-500 font-bold uppercase tracking-widest bg-transparent backdrop-blur-md rounded-full">Or Type History</span>
                                </div>

                                <div>
                                    <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Conversation</label>
                                    <textarea 
                                        className="w-full glass-input rounded-2xl p-4 text-sm resize-none h-24 placeholder-gray-500 font-mono"
                                        placeholder="Her: Hey..."
                                        value={chatHistory}
                                        onChange={(e) => setChatHistory(e.target.value)}
                                    ></textarea>
                                </div>
                                <div>
                                    <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">Vibe</label>
                                    <select 
                                        value={myVibe}
                                        onChange={(e) => setMyVibe(e.target.value)}
                                        className="w-full vibe-select glass-input rounded-xl p-4 text-sm cursor-pointer"
                                    >
                                        <option>Funny & Witty</option>
                                        <option>Direct & Confident</option>
                                        <option>Casual & Low-key</option>
                                        <option>Intellectual & Deep</option>
                                        <option>Flirty & Playful</option>
                                        <option>Sexting (Spicy)</option>
                                    </select>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-6 animate-fade-in">
                                <div>
                                    <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 ml-1">API Key</label>
                                    <div className="relative">
                                        <input 
                                            type="password" 
                                            className="w-full glass-input rounded-xl p-4 pl-10 text-sm placeholder-gray-600"
                                            placeholder="Paste Gemini Key..."
                                            value={apiKey}
                                            onChange={(e) => handleSaveKey(e.target.value)}
                                        />
                                        <i className="fa-solid fa-key absolute left-4 top-4 text-gray-500"></i>
                                    </div>
                                    <p className="text-[10px] text-gray-500 mt-2 ml-1 opacity-60">Stored securely on your device.</p>
                                </div>

                                <div className="bg-white/5 border border-white/10 rounded-2xl p-5 backdrop-blur-sm">
                                    <label className="block text-[10px] font-bold text-indigo-300 uppercase tracking-widest mb-3">Output Languages (Max 3)</label>
                                    <div className="flex flex-wrap gap-2">
                                        {AVAILABLE_LANGS.map(lang => (
                                            <LanguageCheckbox 
                                                key={lang} 
                                                lang={lang} 
                                                selected={selectedLangs.includes(lang)}
                                                toggle={toggleLanguage}
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {(activeTab !== 'settings') && (vibeAnalysis || suggestions.length > 0) && (
                            <div ref={resultsRef} className="mt-8 pt-6 pb-20 animate-slide-up">
                                {vibeAnalysis && (
                                    <div className="bg-gradient-to-r from-indigo-500/20 to-purple-500/20 border border-white/10 rounded-2xl p-4 mb-5 backdrop-blur-md">
                                        <h4 className="text-indigo-300 text-[10px] font-bold uppercase tracking-widest mb-1.5 flex items-center gap-2">
                                            <i className="fa-solid fa-wave-square"></i> Vibe Analysis
                                        </h4>
                                        <p className="text-gray-200 text-xs italic opacity-90">{vibeAnalysis}</p>
                                    </div>
                                )}

                                        <h3 className="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-3 pl-1">
                                            Suggestions
                                        </h3>
                                        {suggestions.map((s, i) => (
                                            <SuggestionCard key={i} title={s.title} text={s.text} onCopy={copyToClipboard} />
                                        ))}
                            </div>
                        )}
                        
                    </div>

                    {/* Bottom Navigation (Solid Dock) */}
                    <div className="absolute bottom-6 left-6 right-6 z-20">
                        <div className="flex bg-[#13111c] border border-white/20 rounded-2xl overflow-hidden shadow-2xl relative z-20">
                            <TabButton active={activeTab === 'opener'} onClick={() => setActiveTab('opener')} icon="fa-bolt" label="Openers" />
                            <TabButton active={activeTab === 'reply'} onClick={() => setActiveTab('reply')} icon="fa-comment-dots" label="Replies" />
                            <TabButton active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} icon="fa-sliders" label="Config" />
                        </div>
                    </div>
                    
                    {/* Floating Action Button (Only visible when not in settings) */}
                    {activeTab !== 'settings' && (
                        <div className="absolute bottom-24 right-6 z-50">
                             {/* Hint Bubble */}
                             {showKeyHint && (
                                 <div className="absolute bottom-full mb-2 right-0 w-32 bg-indigo-600 text-white text-[10px] font-bold py-2 px-3 rounded-xl shadow-xl animate-fade-in text-center after:content-[''] after:absolute after:top-full after:right-6 after:border-4 after:border-transparent after:border-t-indigo-600">
                                    Connect API Key in Config to start
                                 </div>
                             )}
                             <button 
                                onClick={() => {
                                    if (!apiKey) {
                                        setShowKeyHint(true);
                                        setTimeout(() => setShowKeyHint(false), 3000);
                                        return;
                                    }
                                    if (loading) return;
                                    generateContent();
                                }}
                                className={`liquid-action-btn w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl shadow-lg transition-all duration-300 ${
                                    loading ? 'opacity-80 cursor-wait' : 
                                    !apiKey ? 'opacity-50 grayscale cursor-pointer' : 
                                    'hover:scale-110 shadow-indigo-500/50'
                                }`}
                            >
                                {loading ? <i className="fa-solid fa-spinner fa-spin text-xl"></i> : <i className="fa-solid fa-wand-magic-sparkles"></i>}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(req => console.log('Service Worker Registered!'))
                .catch(err => console.log('Service Worker Failed', err));
        });
    }

</script>
</body>
</html>